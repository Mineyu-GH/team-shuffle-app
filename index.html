<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チーム席替えアプリ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .teams-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .team-box {
            border: 2px solid #333;
            border-radius: 12px;
            padding: 15px;
            background-color: #f8f9fa;
            min-width: 200px;
        }
        .team-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .member-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .member-btn {
            padding: 8px 12px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .member-btn:hover {
            background-color: #007bff;
            color: white;
        }
        .member-btn.inactive {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
            opacity: 0.6;
        }
        .shuffle-section {
            text-align: center;
            margin-top: 30px;
        }
        .shuffle-btn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .shuffle-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>チーム席替えアプリ</h1>
    
    <div class="input-section">
        <div class="input-group">
            <label for="teamCount">チーム数:</label>
            <input type="number" id="teamCount" value="3" min="2" max="10">
        </div>
        <div class="input-group">
            <label for="membersPerTeam">1チームあたりの人数:</label>
            <input type="number" id="membersPerTeam" value="4" min="2" max="10">
        </div>
        <button onclick="initializeTeams()">チーム初期化</button>
    </div>

    <div id="teamsDisplay" class="teams-container"></div>

    <div class="shuffle-section">
        <button class="shuffle-btn" onclick="shuffleTeams()">席替え実行</button>
    </div>

    <script>
        class Member {
            constructor(id, teamName, tag) {
                this.isActive = true;
                this.id = id;
                this.teamName = teamName;
                this.tag = tag;
            }

            toggleActive() {
                this.isActive = !this.isActive;
            }
        }

        class Team {
            constructor(teamName, teamId) {
                this.teamName = teamName;
                this.teamId = teamId;
                this.members = [];
            }
        }

        let teams = [];
        let allMembers = [];
        let pairHistory = new Map(); // ペアの同チーム履歴を記録

        function getPairKey(memberId1, memberId2) {
            return memberId1 < memberId2 ? `${memberId1}-${memberId2}` : `${memberId2}-${memberId1}`;
        }

        function recordCurrentTeams() {
            // 現在のチーム構成をペア履歴に記録
            teams.forEach(team => {
                const activeTeamMembers = team.members.filter(m => m.isActive);
                for (let i = 0; i < activeTeamMembers.length; i++) {
                    for (let j = i + 1; j < activeTeamMembers.length; j++) {
                        const pairKey = getPairKey(activeTeamMembers[i].id, activeTeamMembers[j].id);
                        pairHistory.set(pairKey, (pairHistory.get(pairKey) || 0) + 1);
                    }
                }
            });
        }

        function getPairHistoryCount(member1, member2) {
            const pairKey = getPairKey(member1.id, member2.id);
            return pairHistory.get(pairKey) || 0;
        }

        function calculateTeamScore(teamMembers) {
            // チーム内のペア履歴の合計（少ないほど良い）
            let score = 0;
            for (let i = 0; i < teamMembers.length; i++) {
                for (let j = i + 1; j < teamMembers.length; j++) {
                    score += getPairHistoryCount(teamMembers[i], teamMembers[j]);
                }
            }
            return score;
        }

        function initializeTeams() {
            const teamCount = parseInt(document.getElementById('teamCount').value);
            const membersPerTeam = parseInt(document.getElementById('membersPerTeam').value);
            
            teams = [];
            allMembers = [];
            pairHistory.clear(); // 履歴をリセット
            let memberId = 0;

            for (let i = 0; i < teamCount; i++) {
                const teamName = String.fromCharCode(65 + i); // A, B, C...
                const team = new Team(teamName, i);
                
                for (let j = 0; j < membersPerTeam; j++) {
                    const tag = `${teamName.toLowerCase()}-${j + 1}`;
                    const member = new Member(memberId++, teamName, tag);
                    team.members.push(member);
                    allMembers.push(member);
                }
                
                teams.push(team);
            }

            // 初期チーム構成を履歴に記録
            recordCurrentTeams();
            displayTeams();
        }

        function displayTeams() {
            const container = document.getElementById('teamsDisplay');
            container.innerHTML = '';

            teams.forEach(team => {
                const teamBox = document.createElement('div');
                teamBox.className = 'team-box';
                
                const teamTitle = document.createElement('div');
                teamTitle.className = 'team-title';
                teamTitle.textContent = `チーム ${team.teamName}`;
                teamBox.appendChild(teamTitle);

                const memberButtons = document.createElement('div');
                memberButtons.className = 'member-buttons';

                team.members.forEach(member => {
                    const button = document.createElement('button');
                    button.className = `member-btn ${member.isActive ? '' : 'inactive'}`;
                    button.textContent = member.tag;
                    button.onclick = () => toggleMember(member.id);
                    memberButtons.appendChild(button);
                });

                teamBox.appendChild(memberButtons);
                container.appendChild(teamBox);
            });
        }

        function toggleMember(memberId) {
            const member = allMembers.find(m => m.id === memberId);
            if (member) {
                member.toggleActive();
                displayTeams();
            }
        }

        function shuffleTeams() {
            const activeMembers = allMembers.filter(m => m.isActive);
            const teamCount = teams.length;
            const baseMembersPerTeam = Math.floor(activeMembers.length / teamCount);
            const extraMembers = activeMembers.length % teamCount;
            
            if (activeMembers.length < teamCount) {
                alert('アクティブなメンバーが少なすぎます');
                return;
            }

            // 現在のチーム構成を履歴に記録
            recordCurrentTeams();

            // 初対面を最大化するチーム配置を生成
            const bestTeamAssignment = optimizeTeamAssignment(activeMembers, teamCount, baseMembersPerTeam, extraMembers);

            // 全てのメンバーを一度全チームから削除
            teams.forEach(team => {
                team.members = [];
            });

            // 最適化されたチーム配置を適用
            bestTeamAssignment.forEach((teamMembers, teamIndex) => {
                const team = teams[teamIndex];
                teamMembers.forEach(member => {
                    member.teamName = team.teamName;
                    team.members.push(member);
                });
            });

            // 非アクティブメンバーを元のチームに戻す
            allMembers.filter(m => !m.isActive).forEach(member => {
                const originalTeamName = member.teamName;
                const team = teams.find(t => t.teamName === originalTeamName);
                if (team) {
                    team.members.push(member);
                }
            });

            displayTeams();
        }

        function optimizeTeamAssignment(activeMembers, teamCount, baseMembersPerTeam, extraMembers) {
            let bestAssignment = null;
            let bestScore = Infinity;
            const maxIterations = 1000; // 最適化の試行回数

            for (let iteration = 0; iteration < maxIterations; iteration++) {
                // ランダムシャッフル
                const shuffledMembers = [...activeMembers];
                for (let i = shuffledMembers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledMembers[i], shuffledMembers[j]] = [shuffledMembers[j], shuffledMembers[i]];
                }

                // チームに配置
                const assignment = [];
                let memberIndex = 0;
                for (let i = 0; i < teamCount; i++) {
                    const targetSize = baseMembersPerTeam + (i < extraMembers ? 1 : 0);
                    const teamMembers = [];
                    for (let j = 0; j < targetSize && memberIndex < shuffledMembers.length; j++) {
                        teamMembers.push(shuffledMembers[memberIndex++]);
                    }
                    assignment.push(teamMembers);
                }

                // スコア計算（全チームのペア履歴合計）
                let totalScore = 0;
                assignment.forEach(teamMembers => {
                    totalScore += calculateTeamScore(teamMembers);
                });

                // より良いスコアなら更新
                if (totalScore < bestScore) {
                    bestScore = totalScore;
                    bestAssignment = assignment.map(team => [...team]);
                }

                // 完璧なスコア（全て初対面）なら早期終了
                if (totalScore === 0) {
                    break;
                }
            }

            return bestAssignment;
        }

        // 初期化
        initializeTeams();
    </script>
</body>
</html>